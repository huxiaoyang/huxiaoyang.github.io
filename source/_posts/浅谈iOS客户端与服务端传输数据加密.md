---
title: 浅谈iOS客户端与服务端传输数据加密
date: 2017-11-19 22:21:50
tags:
---

前一段时间，公司项目要求做数据传输加密，想要的效果是：放抓包，防破解数据
私下各种Google研究了一些，最近整理一下，决定在这里分享。

# HTTPS

我们使用的是HTTPS协议，相比较HTTP，多了一层secure，这是由TLS（SSL）提供的。它起到的作用是，你浏览的页面的内容如果被人中途看见，将会是一团乱码。不会发生比如和你用同一个无线网的人收到一个你发的数据包，打开来一看，哇~明文信息！

但是HTTPS并不能防止中间人攻击，比如用户可以给手机设置HTTPS的SSL代理（比如Charles），完全可以在代理中看到明文数据。

不要错误的以为使用了HTTPS就安全了！

正确的做法是：我们要在App端严格验证服务器的合法性，防止网络中间的代理或者防火墙进行中间人的攻击和证书欺骗，那么我们需要把服务器配置的证书打包到客户端程序中(私钥留服务器不要分发不用泄露，非常重要)，在代码里去读取该证书/公钥信息和服务器返回的进行匹配验证。这样就可以防止中间人攻击了，如果用Charles抓包，会显示`unknown`

常用的AFNetworking，可以很方便的设置证书的单向认证，这里就不做介绍了，不了解的自行Google吧^_^

# 数据加密算法

虽然我们使用了HTTPS，也加了证书单向认证，我们防止了抓包，但是还是不能保证数据不被篡改。

比如，服务器采用负载均衡的部署方式，数据包在内网的服务器之间会有转发，这个时候就是明文了。

这时候怎么办呢？

我们对传输数据进行加密。既然加密，就需要加密算法，常用的算法有对称加密算法（DES/AES）和非对称加密算法（RSA）。

关于他们的区别可以参考[浅析DES与AES、RSA三种典型加密算法的比较](http://www.jiamisoft.com/blog/21306-deses.html)

在这里详细介绍一下RSA+DES/AES的使用

简单来说就是，对称加密我们需要一个安全密钥，这个密钥服务端要和客户端保持一致，实际的使用我们经常会使用动态的安全密钥，不管是服务端生成还是客户端生成，这个时候都需要传输这个密钥，这时候明文传输很危险，所以我们使用RSA对安全密钥进行加密

## RSA加密过程

{% asset_img RSA.png 模拟登录 %}

## RSA+DES加密过程

{% asset_img RSA+DES.png 模拟登录 %}

大概的使用步骤，就是这样，实际的开发中可以做一些调整，比如，DES对话密钥，并不需要每次请求都更换，可以做一个策略，完成隔一段时间动态生成一个。这样在DES/AES对话密钥不变的情况下，我们可以使用HTTP POST传输方式，对整个body进行DES/AES加密。

## iOS加密算法

没有整理Demo，只是收集了一些算法，谨做参考
[HYTestEncrypt](https://github.com/huxiaoyang/HYTestEncrypt)